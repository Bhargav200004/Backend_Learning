#!/usr/bin/env bash
set -e

# 1. Pick staged JS/TS source files (skip __test__ and *.test.*)
FILES=$(git diff --cached --name-only --diff-filter=ACMR |
        grep -E '^src/.*\.(jsx?|tsx?)$' |
        grep -vE '__test__|\.test\.(jsx?|tsx?)$')

# 2. If no source files changed, exit early
if [ -z "$FILES" ]; then
  echo "ğŸŸ¡ No src/* code changes â€“ skipping tests, coverage, and lint."
  exit 0
fi

# 3. Ensure every changed source file has a matching test file
MISSING=0
for FILE in $FILES; do
  base=$(basename "$FILE" | sed -E 's/\.(jsx?|tsx?)$//')
  ext="${FILE##*.}"
  test_path=$(find src/__test__ -type f -name "${base}.test.${ext}" | head -n1)
  if [ -z "$test_path" ]; then
    echo "âŒ Missing test for $FILE  (expecting src/__test__/**/${base}.test.${ext})"
    MISSING=1
  fi
done
[ "$MISSING" -eq 1 ] && { echo "ğŸš« Commit rejected â€“ add the missing tests."; exit 1; }

# 4. Run the unit tests
echo "ğŸ§ª Running testsâ€¦"
npm test || { echo "ğŸš« Commit rejected â€“ tests failed."; exit 1; }

# 5. Perâ€‘file coverage â‰¥â€¯80â€¯%
echo "ğŸ“Š Checking coverage per file (â‰¥â€¯80â€¯%)â€¦"
COVER_OK=1
for FILE in $FILES; do
  if ! npx vitest run --coverage.enabled true --coverage.include="$FILE" --coverage.threshold.lines=80 >/dev/null; then
    echo "âŒ Coverage below 80â€¯% for $FILE"
    COVER_OK=0
  fi
done
[ "$COVER_OK" -eq 0 ] && { echo "ğŸš« Commit rejected â€“ increase coverage."; exit 1; }

# 6. Lintâ€‘staged (ESLint / Prettier / whatever you configured)
echo "ğŸ§¹ Running lintâ€‘stagedâ€¦"
if ! npx lint-staged; then
  echo "ğŸš« Commit rejected â€“ lintâ€‘staged found problems."
  exit 1
fi

echo "âœ… All preâ€‘commit checks passed â€“ good to go!"
